# 2.1 综述

shader只是渲染流水线中的一个环节。

## 2.1.2 什么是渲染流水线

《Real-Time Rendering, Third Edition》中将一个渲染流程分成3个阶段：

![](3Stage.png)
- 应用阶段（Application Stage）
  - 由CPU负责实现，开发者具有绝对控制权。
  - 开发者有3个主要任务：
    1. 准备好场景数据，例如摄像机的位置、视锥体、模型、光源等；
    2. 为了提高渲染性能，需要做一个粗粒度剔除（culling）工作，把不可见物体剔除；
    3. 设置每个模型的渲染状态，最重要的是输出渲染所需的几何信息，即**渲染图元（rendering primitives）**。
- 几何阶段（Geometry Stage）
    - 用于处理所有和要绘制的几何相关的工作。例如，需要绘制的图元是什么，怎样绘制等。通常在GPU上进行。
    - 进行逐顶点、逐多边形的操作，可以进一步分成更小的流水线阶段。
    - 重要任务是把顶点坐标变换到屏幕空间中，再交给光栅器进行处理。
- 光栅化阶段（Rasterizer Stage）
    - 在GPU上使用传入的数据来产生屏幕上的像素，并渲染出最终的图像。
    - 主要任务是决定每个渲染图元中的哪些像素应该被绘制。对传入的逐顶点数据进行插值，然后再逐像素处理。

# 2.2 CPU和GPU之间的通信

渲染流水线的起点是CPU，即应用阶段。应用阶段大致可分为下面3个阶段：
1. 把数据加载到显存中。
2. 设置渲染状态。
3. 调用Draw Call。

## 2.2.1 把数据加载到显存中

所有数据都需要从硬盘加载到系统内存中，其中网格和纹理数据等数据又被加载到显存中，因为显卡对于显存的访问速度更快，且显卡一般没有访问RAM的权限。

## 2.2.2 设置渲染状态
**渲染状态:** 这些状态定义了场景中的网格是怎样被渲染的。

## 2.2.3 调用 Draw Call
**Draw Call**就是一个命令，发起方是CPU，接受方是GPU。这个命令仅仅会指向一个需要被渲染的图元（primitives），而不会包含任何材质信息。
当给定了一个Draw Call，GPU就会根据渲染状态和所有顶点数据来计算，并最终输出像素。这个计算过程就是GPU流水线。

# 2.3 GPU流水线

## 2.3.1 概述

渲染流水线接收顶点数据作为输入，传递给几何阶段流水线：
1. **顶点着色器**：完全可编程，通常用于实现顶点的空间变换、顶点着色等功能。
2. **曲面细分着色器**：可选着色器，用于细分图元。
3. **几何着色器**：可选着色器，执行逐图元的着色操作，或者用于产生更多图元。
4. **裁剪**：可配置阶段，将那些不在摄像机视野内的顶点裁剪掉，并剔除某些三角图元的面片。
5. **屏幕映射**：不可配置和编程，把图元坐标转换到屏幕坐标系。

然后进入光栅化阶段：
1. **三角形设置**：不可配置和编程。
2. **三角形遍历**：不可配置和编程。
3. **片元着色器**：完全可编程，用于实现逐片元的着色操作。
4. **逐片元操作**：不可编程，可配置。

## 2.3.2 顶点着色器

特性：
1. 处理单位是顶点，每个顶点都会调用一次着色器。
2. 不可以创建或销毁任何顶点。
3. 无法得知顶点之间的关系。

职责：
1. 坐标变换：把顶点坐标从模型空间转换到齐次剪裁空间。
2. 逐顶点光照。
3. 输出后续阶段所需数据。

## 2.3.3 裁剪

区分在摄像机视野内和视野外的图元，并对一部分在视野内的图元进行处理。

## 2.3.4 屏幕映射

把每个图元的x，y坐标转换到**屏幕坐标系**下。剩下的z坐标和屏幕坐标系构成了**窗口坐标系**。这些值会被传递到光栅化阶段。

## 2.3.5 三角形设置
计算光栅化一个三角形网格所需的所有信息。通过传入的顶点数据计算三角网格覆盖的像素坐标。

## 2.3.6 三角形遍历

检查每个像素是否被一个三角形网格所覆盖。如果被覆盖就会生成一个**片元(fragment)**。这个过程也被称为**扫描变换**。

## 2.3.7 片元着色器
在 DirectX 中被称为**像素着色器**。输入是上一个阶段对顶点信息插值得到的结果，输出是一个或多个颜色值。

## 2.3.8 逐片元操作
在 DirectX 中被称为**输出合并阶段**。
这一阶段的主要任务：
   1. 决定每个片元的可见性，需要做很多测试。
   2. 如果一个片元通过了所有测试，将其颜色值和已经存储在颜色缓冲区中的颜色进行合并，或者说混合。

## 2.3.9 总结

# 2.4 一些容易困惑的地方



